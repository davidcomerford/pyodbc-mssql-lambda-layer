name: Create Lambda Layer

on:
  push:
    tags: [ 'v*.*.*' ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        architecture: [x86_64] # [x86_64, arm64]
        python-version: ['3.11', '3.12']

    steps:
    - uses: actions/checkout@v3

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: ${{ matrix.architecture }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build the Docker image
      run: |
        docker buildx build --platform linux/${{ matrix.architecture }} --load --file Dockerfile.python.${{ matrix.python-version }} --tag pyodbc-mssql-${{ matrix.architecture }} .

    - name: Create Container from Image
      run: |
        docker run --rm --volume $(pwd):/tmp pyodbc-mssql-${{ matrix.architecture }} cp /layer.zip /tmp/pyodbc-mssql-python-${{ matrix.python-version }}-${{ matrix.architecture }}.zip

    - name: Run Tests
      run: |
        docker run -d --name tester --entrypoint tail pyodbc-mssql -f /dev/null
        docker cp tests/test_pyodbc.py tester:/tmp
        docker exec -it tester bash -c "pip install pytest"
        docker exec -it tester bash -c "pytest /tmp/test_pyodbc.py"

    - name: Upload layer artifact
      uses: actions/upload-artifact@v4
      with:
        name: pyodbc-mssql-python-${{ matrix.python-version }}-${{ matrix.architecture }}
        path: pyodbc-mssql-python-${{ matrix.python-version }}-${{ matrix.architecture }}.zip
        retention-days: 1

  create-release:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4

      - name: List artifacts
        run: find

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "pyodbc-mssql-python-*/*.zip"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref_name }}
